name: Deploy to Staging

# Required GitHub Secrets (configure in repository settings):
# - STAGING_DATABASE_URL: PostgreSQL connection string for staging database
# - STAGING_JWT_SECRET: JWT signing secret for staging environment
# - STAGING_POSTGRES_DB: PostgreSQL database name
# - STAGING_POSTGRES_USER: PostgreSQL username
# - STAGING_POSTGRES_PASSWORD: PostgreSQL password
# - STAGING_REDIS_PASSWORD: Redis password (optional)
# - STAGING_RAZORPAY_KEY_ID: Razorpay API key ID (optional)
# - STAGING_RAZORPAY_KEY_SECRET: Razorpay API key secret (optional)
# - STAGING_SENTRY_DSN: Sentry DSN for error tracking (optional)
# - STAGING_API_URL: Backend API URL (optional, defaults to http://localhost:5001/api)

on:
  # DISABLED: Auto-deployment disabled - focus on development/testing
  # Uncomment 'push' trigger when ready to deploy to staging environment
  # push:
  #   branches:
  #     - develop
  workflow_dispatch:  # Manual trigger only

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE_NAME: ${{ github.repository }}/backend
  FRONTEND_IMAGE_NAME: ${{ github.repository }}/frontend

jobs:
  pre-deploy-checks:
    name: Pre-Deploy Checks
    runs-on: ubuntu-latest
    outputs:
      backend-image: ${{ steps.images.outputs.backend }}
      frontend-image: ${{ steps.images.outputs.frontend }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check if Docker images exist
        id: images
        run: |
          echo "backend=${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "frontend=${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Verify staging environment variables
        run: |
          if [ -z "${{ secrets.STAGING_DATABASE_URL }}" ]; then
            echo "Error: STAGING_DATABASE_URL not set"
            exit 1
          fi
          if [ -z "${{ secrets.STAGING_JWT_SECRET }}" ]; then
            echo "Error: STAGING_JWT_SECRET not set"
            exit 1
          fi
          echo "✓ Required secrets are configured"

  database-migration:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: pre-deploy-checks

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Validate DATABASE_URL format
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
        run: |
          echo "Checking DATABASE_URL format (without exposing sensitive data)..."
          if [[ ! "$DATABASE_URL" =~ ^postgresql://[^:]+:[^@]+@[^:]+:[0-9]+/.+ ]]; then
            echo "ERROR: DATABASE_URL format is invalid"
            echo "Expected format: postgresql://user:password@host:port/database"
            echo "Detected issues:"
            if [[ ! "$DATABASE_URL" =~ :[0-9]+/ ]]; then
              echo "  - Port number missing or invalid"
            fi
            exit 1
          fi
          echo "✓ DATABASE_URL format is valid"

      - name: Create backup
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
        run: |
          if [ -f backend/scripts/backup-db.sh ]; then
            chmod +x backend/scripts/backup-db.sh
            ./backend/scripts/backup-db.sh staging-pre-deploy || echo "Backup skipped or failed (non-blocking)"
          else
            echo "Backup script not found, skipping..."
          fi

      - name: Run migrations
        working-directory: ./backend
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
        run: |
          echo "Running Prisma migrations..."
          npx prisma migrate deploy
          echo "Generating Prisma client..."
          npx prisma generate
          echo "✓ Migrations completed successfully"

      - name: Verify database health
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
        run: |
          if [ -f backend/scripts/db-health-check.sh ]; then
            chmod +x backend/scripts/db-health-check.sh
            ./backend/scripts/db-health-check.sh
          else
            echo "Health check script not found, performing basic check..."
            cd backend
            npx prisma db execute --stdin <<< "SELECT 1;" > /dev/null && echo "✓ Database connection successful"
          fi

  deploy-staging:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks, database-migration]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull latest Docker images
        run: |
          docker pull ${{ needs.pre-deploy-checks.outputs.backend-image }} || docker pull ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:latest
          docker pull ${{ needs.pre-deploy-checks.outputs.frontend-image }} || docker pull ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:latest

      - name: Create .env.staging file
        run: |
          cat > .env.staging << EOF
          # Database
          POSTGRES_DB=${{ secrets.STAGING_POSTGRES_DB }}
          POSTGRES_USER=${{ secrets.STAGING_POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.STAGING_POSTGRES_PASSWORD }}
          POSTGRES_PORT=5433
          DATABASE_URL=${{ secrets.STAGING_DATABASE_URL }}

          # Redis
          REDIS_HOST=redis
          REDIS_PORT=6379
          REDIS_PASSWORD=${{ secrets.STAGING_REDIS_PASSWORD }}

          # Application
          NODE_ENV=staging
          JWT_SECRET=${{ secrets.STAGING_JWT_SECRET }}

          # Payment
          RAZORPAY_KEY_ID=${{ secrets.STAGING_RAZORPAY_KEY_ID }}
          RAZORPAY_KEY_SECRET=${{ secrets.STAGING_RAZORPAY_KEY_SECRET }}

          # Monitoring
          SENTRY_DSN=${{ secrets.STAGING_SENTRY_DSN }}

          # Docker Images
          BACKEND_IMAGE=${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:latest
          FRONTEND_IMAGE=${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:latest

          # Ports
          BACKEND_PORT=5001
          FRONTEND_PORT=3001

          # Frontend API URL
          REACT_APP_API_URL=${{ secrets.STAGING_API_URL || 'http://localhost:5001/api' }}
          EOF

      - name: Stop existing containers
        run: |
          docker-compose -f docker-compose.staging.yml --env-file .env.staging down || true

      - name: Deploy with Docker Compose
        run: |
          docker-compose -f docker-compose.staging.yml --env-file .env.staging up -d

      - name: Wait for services to be ready
        run: |
          echo "Waiting for backend to be ready..."
          timeout 60 bash -c 'until curl -f http://localhost:5001/monitoring/health > /dev/null 2>&1; do sleep 2; done'

          echo "Waiting for frontend to be ready..."
          timeout 60 bash -c 'until curl -f http://localhost:3001/health > /dev/null 2>&1; do sleep 2; done'

          echo "✓ Services are ready"

      - name: Check container status
        run: |
          docker-compose -f docker-compose.staging.yml --env-file .env.staging ps

          # Check if all services are running
          if docker-compose -f docker-compose.staging.yml --env-file .env.staging ps | grep -q "Exit"; then
            echo "Error: Some containers exited"
            docker-compose -f docker-compose.staging.yml --env-file .env.staging logs
            exit 1
          fi

  post-deploy-verification:
    name: Post-Deploy Verification
    runs-on: ubuntu-latest
    needs: deploy-staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run smoke tests
        run: |
          chmod +x scripts/smoke-tests.sh
          ./scripts/smoke-tests.sh --api-url=http://localhost:5001 --frontend-url=http://localhost:3001

      - name: Check backend health
        run: |
          response=$(curl -s http://localhost:5001/monitoring/health)
          echo "Health check response: $response"

          if echo "$response" | grep -q '"status":"healthy"'; then
            echo "✓ Backend health check passed"
          else
            echo "✗ Backend health check failed"
            exit 1
          fi

      - name: Check frontend health
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3001/health)

          if [ "$response" = "200" ]; then
            echo "✓ Frontend health check passed"
          else
            echo "✗ Frontend health check failed (HTTP $response)"
            exit 1
          fi

      - name: Test critical user journeys
        run: |
          # Test user registration
          echo "Testing user registration..."
          response=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -d '{"email":"test-'$(date +%s)'@staging.com","password":"Test@123","name":"Test User","role":"CLIENT"}' \
            http://localhost:5001/api/auth/register)

          if echo "$response" | grep -q '"success"\|"token"'; then
            echo "✓ User registration working"
          else
            echo "⚠ User registration may have issues"
          fi

      - name: Generate deployment summary
        if: always()
        run: |
          echo "## Staging Deployment Summary :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Staging" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: \`${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: \`${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY

  rollback-on-failure:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy-staging, post-deploy-verification]
    if: failure()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Notify failure
        run: |
          echo "⚠️ Staging deployment failed - rollback may be required"
          echo "Check the logs for details"

      - name: Stop failed deployment
        run: |
          docker-compose -f docker-compose.staging.yml down || true

      - name: Restore previous deployment
        run: |
          echo "Manual rollback may be required"
          echo "Previous backup location: Check artifacts or backup storage"

  notify-deployment:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [post-deploy-verification]
    if: always()

    steps:
      - name: Deployment Success
        if: needs.post-deploy-verification.result == 'success'
        run: |
          echo "✓ Staging deployment completed successfully"
          echo "Environment URL: http://staging.camarketplace.com"

      - name: Deployment Failure
        if: needs.post-deploy-verification.result != 'success'
        run: |
          echo "✗ Staging deployment failed"
          exit 1
