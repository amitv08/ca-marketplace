// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  CLIENT
  CA
  ADMIN
  SUPER_ADMIN
}

enum Permission {
  // Client permissions
  CREATE_SERVICE_REQUEST
  VIEW_OWN_REQUESTS
  UPDATE_OWN_REQUEST
  CANCEL_OWN_REQUEST
  CREATE_REVIEW
  VIEW_OWN_REVIEWS
  MESSAGE_ASSIGNED_CA
  VIEW_OWN_PAYMENTS

  // CA permissions
  VIEW_ASSIGNED_REQUESTS
  ACCEPT_REQUEST
  REJECT_REQUEST
  UPDATE_REQUEST_STATUS
  UPDATE_OWN_PROFILE
  MANAGE_AVAILABILITY
  MESSAGE_OWN_CLIENTS
  VIEW_OWN_EARNINGS

  // Admin permissions
  VIEW_ALL_USERS
  VIEW_ALL_REQUESTS
  VIEW_ALL_PAYMENTS
  VERIFY_CA
  REJECT_CA
  RELEASE_PAYMENT
  VIEW_PLATFORM_STATS
  MANAGE_SERVICE_TYPES

  // Super Admin permissions
  MANAGE_ADMINS
  MANAGE_PLATFORM_SETTINGS
  DELETE_USERS
  REFUND_PAYMENTS
  VIEW_AUDIT_LOGS
  MANAGE_PERMISSIONS
}

enum Specialization {
  GST
  INCOME_TAX
  AUDIT
  ACCOUNTING
  FINANCIAL_PLANNING
  TAX_PLANNING
  COMPANY_LAW
  OTHER
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum ServiceType {
  GST_FILING
  INCOME_TAX_RETURN
  AUDIT
  ACCOUNTING
  TAX_PLANNING
  FINANCIAL_CONSULTING
  COMPANY_REGISTRATION
  OTHER
}

enum ServiceRequestStatus {
  PENDING
  ACCEPTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  NET_BANKING
  UPI
  WALLET
  CASH
  RAZORPAY
}

// Models

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  password     String
  role         UserRole
  name         String
  phone        String?
  profileImage String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  client              Client?
  charteredAccountant CharteredAccountant?
  sentMessages        Message[]            @relation("SentMessages")
  receivedMessages    Message[]            @relation("ReceivedMessages")

  // Indexes
  @@index([email])
  @@index([role])
  @@index([createdAt])
  @@index([role, createdAt]) // Composite: Get users by role with sorting
}

model Client {
  id          String  @id @default(uuid())
  userId      String  @unique
  companyName String?
  address     String?
  taxNumber   String?
  documents   Json?   // Array of document URLs/metadata

  // Relations
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  serviceRequests ServiceRequest[]
  reviews         Review[]
  payments        Payment[]

  @@index([userId])
}

model CharteredAccountant {
  id                 String             @id @default(uuid())
  userId             String             @unique
  caLicenseNumber    String             @unique
  specialization     Specialization[]
  experienceYears    Int
  qualifications     String[] // Array of qualification strings
  verificationStatus VerificationStatus @default(PENDING)
  hourlyRate         Float
  description        String?            @db.Text
  languages          String[] // Array of languages spoken
  availability       Json? // Store complex availability data

  // Relations
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  serviceRequests ServiceRequest[]
  reviews         Review[]
  payments        Payment[]
  availabilities  Availability[]

  // Indexes
  @@index([userId])
  @@index([caLicenseNumber])
  @@index([verificationStatus])
  @@index([hourlyRate])
  @@index([experienceYears])
  // Composite indexes for CA search and filtering
  @@index([verificationStatus, hourlyRate]) // Search verified CAs by price
  @@index([verificationStatus, experienceYears]) // Search verified CAs by experience
  @@index([verificationStatus, hourlyRate, experienceYears]) // Combined search filters
}

model ServiceRequest {
  id             String               @id @default(uuid())
  clientId       String
  caId           String?
  serviceType    ServiceType
  status         ServiceRequestStatus @default(PENDING)
  description    String               @db.Text
  documents      Json? // Array of document URLs/metadata
  deadline       DateTime?
  estimatedHours Float?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  // Relations
  client Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  ca     CharteredAccountant? @relation(fields: [caId], references: [id], onDelete: SetNull)

  messages Message[]
  reviews  Review[]
  payments Payment[]

  // Indexes
  @@index([clientId])
  @@index([caId])
  @@index([status])
  @@index([createdAt])
  @@index([serviceType])
  @@index([deadline])
  // Composite indexes for efficient queries
  @@index([clientId, status, createdAt]) // Client's requests filtered by status
  @@index([caId, status, createdAt]) // CA's requests filtered by status
  @@index([status, createdAt]) // All requests by status with pagination
  @@index([serviceType, status]) // Requests by type and status
  @@index([status, deadline]) // Pending requests sorted by deadline
}

model Message {
  id         String   @id @default(uuid())
  senderId   String
  receiverId String
  requestId  String?
  content    String   @db.Text
  attachments Json? // Array of attachment URLs/metadata
  readStatus Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  sender  User            @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User           @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  request ServiceRequest? @relation(fields: [requestId], references: [id], onDelete: SetNull)

  // Indexes
  @@index([senderId])
  @@index([receiverId])
  @@index([requestId])
  @@index([createdAt])
  @@index([readStatus])
  // Composite indexes for efficient message queries
  @@index([receiverId, readStatus, createdAt]) // Unread messages for user
  @@index([senderId, createdAt]) // Sent messages sorted by date
  @@index([receiverId, createdAt]) // Received messages sorted by date
  @@index([requestId, createdAt]) // Messages in a conversation
  @@index([senderId, receiverId, createdAt]) // Conversation between two users
}

model Review {
  id        String   @id @default(uuid())
  clientId  String
  caId      String
  requestId String   @unique
  rating    Int // 1-5 stars
  comment   String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  client  Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  ca      CharteredAccountant @relation(fields: [caId], references: [id], onDelete: Cascade)
  request ServiceRequest      @relation(fields: [requestId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([clientId])
  @@index([caId])
  @@index([requestId])
  @@index([rating])
  @@index([createdAt])
  // Composite indexes for review queries
  @@index([caId, rating, createdAt]) // CA reviews filtered by rating
  @@index([caId, createdAt]) // Recent reviews for CA
  @@index([clientId, createdAt]) // Reviews by client
}

model Payment {
  id                 String        @id @default(uuid())
  clientId           String
  caId               String
  requestId          String
  amount             Float
  platformFee        Float?        // 10% platform commission
  caAmount           Float?        // Amount to be paid to CA (90%)
  status             PaymentStatus @default(PENDING)
  paymentMethod      PaymentMethod
  transactionId      String?       @unique
  razorpayOrderId    String?       @unique
  razorpayPaymentId  String?       @unique
  razorpaySignature  String?
  releasedToCA       Boolean       @default(false)
  releasedAt         DateTime?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  // Relations
  client  Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  ca      CharteredAccountant @relation(fields: [caId], references: [id], onDelete: Cascade)
  request ServiceRequest      @relation(fields: [requestId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([clientId])
  @@index([caId])
  @@index([requestId])
  @@index([status])
  @@index([transactionId])
  @@index([razorpayOrderId])
  @@index([razorpayPaymentId])
  @@index([releasedToCA])
  @@index([createdAt])
  // Composite indexes for payment queries
  @@index([clientId, status, createdAt]) // Client's payments by status
  @@index([caId, status, createdAt]) // CA's earnings by status
  @@index([status, releasedToCA]) // Admin: Payments to release
  @@index([caId, releasedToCA, createdAt]) // CA's pending earnings
  @@index([status, createdAt]) // All payments with pagination
}

model Availability {
  id        String   @id @default(uuid())
  caId      String
  date      DateTime @db.Date
  startTime DateTime @db.Time
  endTime   DateTime @db.Time
  isBooked  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ca CharteredAccountant @relation(fields: [caId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([caId])
  @@index([date])
  @@index([isBooked])
  // Composite indexes for availability queries
  @@index([caId, date, isBooked]) // Find available slots for CA on date
  @@index([caId, isBooked, date]) // CA's available/booked slots sorted by date
  @@index([date, isBooked]) // All available slots on a date
}

model PasswordHistory {
  id           String   @id @default(uuid())
  userId       String
  passwordHash String
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

model RolePermission {
  id         String     @id @default(uuid())
  role       UserRole
  permission Permission
  createdAt  DateTime   @default(now())

  @@unique([role, permission])
  @@index([role])
  @@index([permission])
}

model AuditLog {
  id          String   @id @default(uuid())
  userId      String?
  userRole    UserRole?
  action      String   // e.g., "CREATE_REQUEST", "VERIFY_CA", "RELEASE_PAYMENT"
  resource    String   // e.g., "ServiceRequest", "CharteredAccountant", "Payment"
  resourceId  String?
  details     Json?    // Additional details about the action
  ipAddress   String?
  userAgent   String?
  success     Boolean  @default(true)
  errorMessage String? @db.Text
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@index([success])
}
